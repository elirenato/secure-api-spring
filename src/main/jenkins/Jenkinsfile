pipeline {
    options {
      timeout(time: 10, unit: 'MINUTES')
      disableConcurrentBuilds()
    }
    agent {
        // Must have Docker Pipeline and Docker Commons Plugin Installed
        // The image name could be used but with the Dockerfile it's possible customize the image if needed
        dockerfile {
            filename 'Dockerfile'
            dir 'src/main/jenkins'
            args """
                -u root:root
                -v /root/.m2:/root/.m2
                -v /var/run/docker.sock:/var/run/docker.sock
            """
        }
    }
    stages {
        stage('Test') {
            steps {
                sh './mvnw clean test'
            }
            // Must have JaCoCo plugin installed
            post {
                always {
                    junit 'target/surefire-reports/*.xml'
                    step( [ $class: 'JacocoPublisher' ] )
                }
            }
        }
        stage('Build') {
            steps {
                sh """
                    ./mvnw -DskipTests package
                    export DOCKER_BUILDKIT=1 && docker build -t secure-api-spring:latest -f ./src/main/docker/deploy/Dockerfile . --no-cache
                """
            }
        }
        stage('Deploy') {
            steps {
                sh """
                    echo "TODO Deploy on self hosted"
                """
            }
        }
    }
}